<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apply Leave - ALMS</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="base.css">
  <style>
    /* Page-specific override: remove left margin reserved for sidebar */
    .main.fullpage { margin-left: 0 !important; }
  </style>
</head>
<body>
  <main class="main fullpage">
    <div class="container">
      <div class="text-center mb-4">
        <h2 class="fw-bold text-primary">Apply for Leave</h2>
        <p class="text-muted">Fill and submit your leave application</p>
      </div>

      <div class="card p-4">
        <form id="leaveForm" method="post" action="https://containers.back4app.com/apps/b20ef7f7-2d91-4c3e-982c-cc65688966c5/api/leave">
          <div class="leave-balances">
            <div class="balance-box"> 
              <span>Casual Leave (CL)</span> 
              <h3 id="casual-leave">-- days</h3> 
            </div>
            <div class="balance-box"> 
              <span>Earned Leave (EL)</span> 
              <h3 id="earned-leave">-- days</h3>
            </div>
            <div class="balance-box"> 
              <span>Hospital Leave (HL)</span> 
              <h3 id="hospital-leave">-- days</h3> 
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Employee ID</label>
              <p id="employeeIdDisplay" class="form-control-static">Loading...</p>
              <input type="hidden" name="userid" id="userid">
            </div>
            <div class="form-group">
              <label>Leave Type</label>
              <select name="leave_type" required>
                <option value="">Select a leave type</option>
                <option value="Casual Leave">Casual Leave</option>
                <option value="Earned Leave">Earned Leave</option>
                <option value="Sick Leave">Sick Leave</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Start Date</label>
              <input type="date" id="start_date" name="start_date" required>
            </div>
            <div class="form-group">
              <label>End Date</label>
              <input type="date" id="end_date" name="end_date" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Number of Days</label>
              <input type="number" id="no_of_days" name="no_of_days" readonly required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Reason for Leave</label>
              <textarea name="reason"></textarea>
            </div>
          </div>

          <div class="checkbox">
            <input type="checkbox" name="away_hq" id="away_hq"> During Leave Away from HQ
          </div>

          <div class="form-buttons mt-3">
            <a href="employee.html" class="btn cancel">Back</a>
            <button type="submit" class="btn submit">Submit</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script>
    // Fetch user id and leave balances
    (async function () {
      try {
        const userRes = await fetch('/api/getUser');
        const userData = await userRes.json();
        const userid = userData.userid || '';
        document.getElementById('employeeIdDisplay').textContent = userid || 'Unknown';
        document.getElementById('userid').value = userid || '';

        if (userid) {
          const balancesRes = await fetch(`/leave-balances/${userid}`);
          const balances = await balancesRes.json();
          if (balances && balances.data) {
            const { casual_leave, earned_leave, sick_leave } = balances.data;
            document.getElementById('casual-leave').textContent = `${casual_leave} days`;
            document.getElementById('earned-leave').textContent = `${earned_leave} days`;
            document.getElementById('hospital-leave').textContent = `${sick_leave} days`;
          }
        }
      } catch (err) {
        console.error('Error loading user or balances', err);
      }
    })();

    // Auto-calc days (inclusive) and form submit
    (function () {
      function calculateNoOfDays() {
        const startEl = document.getElementById('start_date');
        const endEl = document.getElementById('end_date');
        const outEl = document.getElementById('no_of_days');
        if (!startEl || !endEl || !outEl) return;
        const start = startEl.value;
        const end = endEl.value;
        if (!start || !end) { outEl.value = ''; return; }
        const s = new Date(start);
        const e = new Date(end);
        const utc1 = Date.UTC(s.getFullYear(), s.getMonth(), s.getDate());
        const utc2 = Date.UTC(e.getFullYear(), e.getMonth(), e.getDate());
        let diffDays = Math.floor((utc2 - utc1) / (1000 * 60 * 60 * 24));
        if (diffDays >= 0) diffDays = diffDays + 1;
        outEl.value = diffDays >= 0 ? diffDays : '';
      }

      document.addEventListener('DOMContentLoaded', function () {
        const s = document.getElementById('start_date');
        const e = document.getElementById('end_date');
        if (s) s.addEventListener('change', calculateNoOfDays);
        if (e) e.addEventListener('change', calculateNoOfDays);
        calculateNoOfDays();
      });

      document.getElementById('leaveForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const startVal = this.start_date.value;
        const endVal = this.end_date.value;
        if (startVal && endVal) {
          const sDate = new Date(startVal);
          const eDate = new Date(endVal);
          if (eDate < sDate) { alert('End date cannot be before start date.'); return; }
        }

        const payload = {
          leave_type: this.leave_type.value,
          start_date: this.start_date.value,
          end_date: this.end_date.value,
          reason: this.reason.value,
          no_of_days: this.no_of_days.value,
          userid: this.userid.value,
          status: 'Pending',
          away_hq: this.away_hq && this.away_hq.checked ? 'yes' : 'no'
        };

        fetch('https://containers.back4app.com/apps/b20ef7f7-2d91-4c3e-982c-cc65688966c5/api/leave', {
          method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
        })
        .then(res => res.json().catch(() => null))
        .then(data => {
          if (data && (data.success === true || data.success === 'true')) {
            alert(data.message || 'Leave application submitted');
            window.location.href = 'employee.html';
          } else {
            alert((data && data.message) || 'Failed to submit leave');
          }
        })
        .catch(err => { console.error(err); alert('An error occurred while submitting leave'); });
      });
    })();
  </script>
</body>
</html>