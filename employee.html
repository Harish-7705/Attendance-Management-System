<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALMS - Employee Attendance & Leave Management System</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="base.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

</head>
<body>
  
    <!-- Header -->
<!-- Sidebar -->
<div id="sidebar" class="sidebar" aria-label="Main Navigation">
    <div class="sidebar-header">
    <div class="logo" id="sidebarLogo" style="cursor:pointer;">
        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiByeD0iNCIgZmlsbD0iIzAwNkZBRiIvPgo8cGF0aCBkPSJNMTAgMTJIMzBWMTZIMTBWMTJaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTAgMjBIMzBWMjRIMTBWMjBaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTAgMjhIMzBWMzJIMTBWMjhaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K" alt="CMRL Logo">
        <span class="logo-text">ALMS</span>
    </div>
</div>
    <nav class="sidebar-nav">
        <ul>
            <li><a href="#dashboard" class="nav-link">Dashboard</a></li>
            <li><a href="#attendance" class="nav-link">Attendance</a></li>
            <li><a href="#leave-applications" class="nav-link">Leave Application</a></li>
            <li><a href="#company-holiday-view-section" class="nav-link">Holidays</a></li>
             <li><a href="Employee_Report.html" onclick="window.location.href='Employee_Report.html'" class="nav-link">Reports</a></li>
              

        </ul>
    </nav>
                    
  <div class="sidebar-user">
    <span class="user-name">Loading...</span>
    <i class="fas fa-user-tie"></i>
    <button class="btn btn-secondary" onclick="logout()" style="margin-left: 10px;">
        <i class="fas fa-sign-out-alt"></i> Logout
    </button>
</div>

<script>

  (function () {
    async function setupEmployeeDropdown() {
      const dropdown = document.getElementById('employeeId');
      if (!dropdown) return;

      // Get user role and id
      let userInfo;
      try {
        const res = await fetch('/user/profile');
        userInfo = await res.json();
      } catch (err) {
        userInfo = { role: 'employee' };
      }

      const isManager = userInfo.role === 'manager';
      const isAdmin = userInfo.role === 'admin';
      if (isManager) {
        // Manager: show all employees
        dropdown.disabled = false;
        dropdown.style.display = '';
        dropdown.innerHTML = `<option value="" disabled selected>Loading...</option>`;
        try {
          const res = await fetch('/api/userids');
          const data = await res.json();
          dropdown.innerHTML = `
            <option value="" disabled selected>Select Employee ID</option>
            <option value="All Employees">All Employees</option>
          `;
          if (Array.isArray(data)) {
            data.forEach(id => {
              const option = document.createElement('option');
              option.value = id;
              option.innerText = id;
              dropdown.appendChild(option);
            });
          }
        } catch (err) {
          dropdown.innerHTML = `<option value="" disabled selected>Error loading IDs</option>`;
        }
      } else {
        // Employee/Admin: show their own ID in a disabled dropdown
        dropdown.disabled = true;
        dropdown.style.display = '';
        dropdown.innerHTML = '';
        const ownId = userInfo.username || userInfo.userid || userInfo.id || '';
        if (ownId) {
          const option = document.createElement('option');
          option.value = ownId;
          option.innerText = ownId;
          option.selected = true;
          dropdown.appendChild(option);
        }
        // Remove required attribute to avoid form errors
        dropdown.removeAttribute('required');
      }
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupEmployeeDropdown);
    } else {
      setupEmployeeDropdown();
    }
  })();
  async function loadUsername() {
    try {
      const res = await fetch('/user/profile');
      const data = await res.json();

      if (res.ok && data.username && data.role) {
        // Capitalize first letter of role
        const roleName = data.role.charAt(0).toUpperCase() + data.role.slice(1);
        document.querySelector('.sidebar-user .user-name').innerText = `${roleName} ${data.username}`;
      } else {
        document.querySelector('.sidebar-user .user-name').innerText = 'Unknown User';
      }
    } catch (err) {
      console.error('Failed to load user info:', err);
      document.querySelector('.sidebar-user .user-name').innerText = 'Error';
    }
  }

  loadUsername();
                              (async function(){
                                try {
                                  const res = await fetch('/user/profile');
                                  const data = await res.json();
                                  const name = data && (data.username || data.name || data.user || '');
                                  document.getElementById('welcomeUsername').innerText = name || 'Unknown User';
                                } catch (e) {
                                  document.getElementById('welcomeUsername').innerText = 'Unknown User';
                                }
                              })();
</script>

  </div>


    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <!-- Dashboard Section -->
            <section id="dashboard" class="section active">
                <div class="dashboard-container">
                    <h1>Welcome, <span id="welcomeUsername" style="color: #00a2fff0;">Loading...</span>👋</h1>
                      <br>
                    
                    <div class="dashboard-grid">
                        <!-- Quick Actions Section (employee only) -->
                        <div class="quick-actions-section">
                            <h2>Quick Actions</h2>
                            <div class="quick-actions-grid">
                                <button class="quick-action-btn" onclick="showSection('attendance')">
                                    <i class="fas fa-clipboard-l
                                    ist"></i>
                                    <span>Mark Attendance</span>
                                </button>
                                <button class="quick-action-btn" onclick="showSection('leave-applications')">
                                    <i class="fas fa-file-alt"></i>
                                    <span>Apply Leave</span>
                                </button>
                               
                            </div>
                        </div>

                        <!-- Overview Section -->
                        <div class="overview-section">
                            <h2>Overview</h2>
                            <div class="overview-stats">
                                <div class="overview-item">
                                    <span class="overview-label">Total Employees</span>
                                    <span class="overview-number" id="totalEmployeesCount">-</span>
                                    
                                </div>
                                <div class="overview-item">
                                    <span class="overview-label">Active Leaves</span>
                                    <span class="overview-number" id="totalLeaveBalance">-</span>
                                </div>
                                <div class="overview-item">
                                    <span class="overview-label">Upcoming Holidays</span>
                                    <span class="overview-number" id="upcomingHolidaysCount">-</span>
                                </div>
                            </div>
                        </div>


                        <!-- Pending Tasks Section -->
                        <div class="pending-tasks-section">
                            <h2>Pending Tasks</h2>
                            <div class="pending-tasks-list">
                                <div class="pending-task-item">
                                    <i class="fas fa-clock"></i>
                                    <span>12 days attendance pending</span>
                                </div>
                                <div class="pending-task-item">
                                    <i class="fas fa-calendar-check"></i>
                                    <span>To Leave sanction pending</span>
                                </div>
                            </div>
                        </div>

                        <!-- System Notifications Section -->
                        <div class="notifications-section">
                            <h2>System Notifications</h2>
                            <div class="notifications-list">
                                <div class="notification-item">
                                    <i class="fas fa-user-plus"></i>
                                    <span>5 new employees onboarded this month</span>
                                </div>
                                <div class="notification-item">
                                    <i class="fas fa-calendar-times"></i>
                                    <span>2 employees on Leave in this month</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <script>
                                      // Fetch and display total employees count (same as manager page)
                                      async function loadTotalEmployeesCount() {
                                        try {
                                          const res = await fetch('/api/userids');
                                          const data = await res.json();
                                          const count = Array.isArray(data) ? data.length : '-';
                                          document.getElementById('totalEmployeesCount').innerText = count;
                                        } catch (err) {
                                          document.getElementById('totalEmployeesCount').innerText = '-';
                                        }
                                      }
                                      loadTotalEmployeesCount();
                                      // Fetch and display total leave balance for current user
                                      async function loadTotalLeaveBalance() {
                                      try {
                                      const userRes = await fetch('/api/getUser');
                                      const userData = await userRes.json();
                                      if (!userRes.ok || !userData.userid) {
                                        throw new Error('Could not fetch user ID');
                                      }
                                      const userid = userData.userid;
                                      
                                      const response = await fetch(`/leave-balances/${userid}`);
                                      const result = await response.json();
                                      if (!result.success) {
                                        throw new Error(result.message);
                                      }
                                      
                                      const total = result.data.casual_leave + 
                                             result.data.earned_leave + 
                                             result.data.sick_leave;
                                      
                                      document.getElementById("totalLeaveBalance").textContent = total;
                                      } catch (err) {
                                      console.error("Failed to load total leave balance:", err);
                                      document.getElementById("totalLeaveBalance").textContent = "-";
                                      }
                                    }
                                    loadTotalLeaveBalance();

                                    // Fetch and display upcoming holidays count
                                     async function loadUpcomingHolidaysCount() {
                                      try {
                                        const res = await fetch('/holidays');
                                        const holidays = await res.json();
                                        const today = new Date();
                                        const upcomingCount = holidays.filter(holiday => {
                                        const holidayDate = new Date(holiday.date);
                                        return holidayDate >= today;
                                        }).length;
                                        document.getElementById('upcomingHolidaysCount').textContent = upcomingCount;
                                      } catch (err) {
                                        console.error('Error loading upcoming holidays:', err);
                                        document.getElementById('upcomingHolidaysCount').textContent = '-';
                                      }
                                      }
                                      loadUpcomingHolidaysCount();
                                    </script>

            <!-- Attendance Section -->
            <section id="attendance" class="section">
                <!-- Employee View -->
                <div id="attendance-employee" class="attendance-employee">
                    <div class="attendance-hero">
                        <h1>Mark Your Attendance</h1>
                        <p>Welcome back! Please clock in to start your day.</p>
                    </div>
                    <div class="attendance-clock">
                        <span class="clock-label">Current Date & Time</span>
                        <div id="liveDateTime" class="clock-display">--</div>
                       <div class="clock-actions">
                          <button id="btnClockIn" class="btn clock-btn" onclick="clockIn()">
                            <i class="fas fa-play-circle"></i> Clock In
                          </button>
                          <button id="btnClockOut" class="btn clock-btn s
                          
                          econdary" onclick="clockOut()">
                            <i class="fas fa-stop-circle"></i> Clock Out
                          </button>
                        </div>
                    
                

                    <div class="attendance-summary">
                        <h2>Today's Summary</h2>
                        <div class="summary-row">
                            <div class="summary-item">
                                <i class="fas fa-sign-in-alt"></i>
                                <div>
                                    <div class="summary-label">Last Clock In</div>
                                    <div id="lastClockIn" class="summary-value">--</div>
                                </div>
                            </div>
                            <div class="summary-item">
                                <i class="fas fa-sign-out-alt"></i>
                                <div>
                                    <div class="summary-label">Last Clock Out</div>
                                    <div id="lastClockOut" class="summary-value">--</div>
                                </div>
                            </div>
                            <div class="summary-item">
                                <i class="fas fa-hourglass-half"></i>
                                <div>
                                    <div class="summary-label">Hours Worked Today</div>
                                    <div id="hoursWorked" class="summary-value">0 hours 0 minutes</div>                                </div>
                            </div>
                        </div>
                        <div class="attendance-links">
                            <a href="#" onclick="showMyAttendanceReport()">My Attendance Report</a>
                        </div>
                    </div>
                    <!-- Today's Log (moved into attendance area) -->
                    <div class="attendance-todays-log">
                      <div class="modern-card">
                        <h3 style="margin:0 0 8px 0; font-size:16px; color:#0b3b5a;">Today's Log</h3>
                        <table id="todaysLogTable" class="styled-table" style="margin-top:8px; width:100%;">
                          <thead>
                            <tr>
                              <th>Clock In</th>
                              <th>Clock Out</th>
                              <th>Working Hours</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr><td colspan="3" style="text-align:center;color:#666;padding:12px;">Loading...</td></tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                </div>
            </section>
            <script>
            // Helper: format hours_worked numeric (hours, possibly fractional) into "X hour(s) Y minute(s)"
            function formatHoursMinutes(value) {
              if (value === null || value === undefined || value === '') return '—';
              const num = Number(value);
              if (isNaN(num)) return String(value);
              let hours = Math.floor(Math.abs(num));
              let minutes = Math.round((Math.abs(num) - hours) * 60);
              if (minutes === 60) { hours += 1; minutes = 0; }
              const hourLabel = hours === 1 ? 'hour' : 'hours';
              const minuteLabel = minutes === 1 ? 'minute' : 'minutes';
              const sign = num < 0 ? '-' : '';
              return `${sign}${hours} ${hourLabel} ${minutes} ${minuteLabel}`;
            }

async function clockIn() {
  const res = await fetch('/clockin', { method: 'POST' });
  const data = await res.json();

  if (res.status === 400 || data.error) {
    alert(data.error || "Clock In failed");
    return;
  }

  document.getElementById('lastClockIn').innerText =
    new Date(data.start_time).toLocaleString();
  loadSummary();
  // refresh today's log
  loadTodaysLog();
}

async function clockOut() {
  const res = await fetch('/clockout', { method: 'POST' });
  const data = await res.json();

  if (res.status === 400 || data.error) {
    alert(data.error || "Clock Out failed");
    return;
  }

  if (data.end_time) {
    document.getElementById('lastClockOut').innerText =
      new Date(data.end_time).toLocaleString();
  }
  if (data.hours_worked !== null) {
    document.getElementById('hoursWorked').innerText = formatHoursMinutes(data.hours_worked);
  }
  loadSummary();
  // refresh today's log
  loadTodaysLog();
}

//   const clockInButton = document.getElementById('btnClockIn');
//   const clockOutButton = document.getElementById('btnClockOut');

//   // Disable Clock In button and style it as "disabled"
//   clockInButton.disabled = true;
//   clockInButton.style.opacity = '0.5'; // Optional: visual feedback of being disabled

//   // Enable Clock Out button when user clocks in
//   clockOutButton.disabled = false;

//   try {
//     const res = await fetch('/clockin', { method: 'POST' });
//     const data = await res.json();

//     if (res.status === 400 || data.error) {
//       alert(data.error || "Clock In failed");
//       // Re-enable the button if there's an error
//       clockInButton.disabled = false;
//       clockInButton.style.opacity = '1';
//       return;
//     }

//     document.getElementById('lastClockIn').innerText =
//       new Date(data.start_time).toLocaleString();
//     loadSummary();
//     loadTodaysLog();
//   } catch (error) {
//     console.error("Clock In Error:", error);
//     clockInButton.disabled = false;
//     clockInButton.style.opacity = '1';
//   }
// }

// async function clockOut() {
//   const clockInButton = document.getElementById('btnClockIn');
//   const clockOutButton = document.getElementById('btnClockOut');

//   // Disable Clock Out button and style it as "disabled"
//   clockOutButton.disabled = true;
//   clockOutButton.style.opacity = '0.5'; // Optional: visual feedback of being disabled

//   // Enable Clock In button after clocking out
//   clockInButton.disabled = false;

//   try {
//     const res = await fetch('/clockout', { method: 'POST' });
//     const data = await res.json();

//     if (res.status === 400 || data.error) {
//       alert(data.error || "Clock Out failed");
//       // Re-enable the button if there's an error
//       clockOutButton.disabled = false;
//       clockOutButton.style.opacity = '1';
//       return;
//     }

//     if (data.end_time) {
//       document.getElementById('lastClockOut').innerText =
//         new Date(data.end_time).toLocaleString();
//     }
//     if (data.hours_worked !== null) {
//       document.getElementById('hoursWorked').innerText =
//         data.hours_worked + " hours";
//     }

//     loadSummary();
//     loadTodaysLog();
//   } catch (error) {
//     console.error("Clock Out Error:", error);
//     clockOutButton.disabled = false;
//     clockOutButton.style.opacity = '1';
//   }
// }

async function loadSummary() {
  const res = await fetch('/summary');
  const data = await res.json();

  if (data.start_time) {
    document.getElementById('lastClockIn').innerText =
      new Date(data.start_time).toLocaleString();
  }
  if (data.end_time) {
    document.getElementById('lastClockOut').innerText =
      new Date(data.end_time).toLocaleString();
  }
  if (data.hours_worked !== null) {
    document.getElementById('hoursWorked').innerText = formatHoursMinutes(data.hours_worked);
  }
}

// Load latest summary on page load
loadSummary();
// Load today's log on page load
document.addEventListener('DOMContentLoaded', loadTodaysLog);

// Fetch and render today's attendance entries
async function loadTodaysLog() {
  const table = document.getElementById('todaysLogTable');
  if (!table) return;
  const tbody = table.querySelector('tbody');
  tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#666;padding:12px;">Loading...</td></tr>';
  try {
    const res = await fetch('/api/attendance');
    if (!res.ok) {
      tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;color:#c00;padding:12px;">Error: ${res.status} ${res.statusText}</td></tr>`;
      return;
    }
    const rows = await res.json();
    if (!Array.isArray(rows) || rows.length === 0) {
      tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#666;padding:12px;">No logs for today</td></tr>';
      return;
    }
    tbody.innerHTML = '';
    rows.forEach(r => {
      const inTime = r.start_time ? new Date(r.start_time).toLocaleString() : '—';
      const outTime = r.end_time ? new Date(r.end_time).toLocaleString() : '—';
      const hours = (r.hours_worked !== null && r.hours_worked !== undefined) ? formatHoursMinutes(r.hours_worked) : '—';
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${inTime}</td><td>${outTime}</td><td>${hours}</td>`;
      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error('Error fetching today\'s log:', err);
    tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;color:#c00;padding:12px;">Error loading logs</td></tr>`;
  }
}
</script>



           
<!-- Leave Application Modal -->
  <div class="modal fade" id="leaveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Apply for Leave</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
        <form id="leaveForm" method="post" action="https://containers.back4app.com/apps/b20ef7f7-2d91-4c3e-982c-cc65688966c5/api/leave">
          <div class="leave-balances">
             <div class="balance-box"> 
              <span>Casual Leave (CL)</span> 
              <h3 id="casual-leave">-- days</h3> 

            </div> 
            <div class="balance-box"> 
              <span>Earned Leave (EL)</span> 
                  <h3 id="earned-leave">-- days</h3> </div> 
              <div class="balance-box"> 
                <span>Hospital Leave (HL)</span> 
                <h3 id="hospital-leave">-- days</h3> 
              </div> 
            </div>
          <form> 
            <div class="form-row"> 
              <div class="form-group">
              <label>Employee ID</label>
              <p id="employeeIdDisplay" class="form-control-static">Loading...</p>
              <input type="hidden" name="userid" id="employeeIdInput">
              
<script>
  // Example: Fetch user data from backend
  fetch("/api/getUser")   // <-- replace with your actual route
    .then(response => response.json())
    .then(data => {
      // assuming backend returns { userid: "EMP123" }
      const userId = data.userid;

      // display it
      document.getElementById("employeeIdDisplay").textContent = userId;

      // store it in hidden input
      document.getElementById("employeeIdInput").value = userId;
    })
    .catch(err => {
      console.error("Error fetching user ID:", err);
      document.getElementById("employeeIdDisplay").textContent = "Error loading ID";
    });
</script>




              <script>
              // Fetch the logged-in user's ID, then load their leave balances
              async function loadLeaveBalancesForCurrentUser() {
                try {
                  // Get the logged-in user's ID from the backend
                  const userRes = await fetch('/api/getUser');
                  const userData = await userRes.json();
                  if (!userRes.ok || !userData.userid) {
                    throw new Error('Could not fetch user ID');
                  }
                  const userid = userData.userid;
                  // Now fetch leave balances for this user
                  const response = await fetch(`/leave-balances/${userid}`);
                  const result = await response.json();
                  if (!result.success) {
                    console.error("Error fetching balances:", result.message);
                    return;
                  }
                  const { casual_leave, earned_leave, sick_leave } = result.data;
                  document.getElementById("casual-leave").textContent = `${casual_leave} days`;
                  document.getElementById("earned-leave").textContent = `${earned_leave} days`;
                  document.getElementById("hospital-leave").textContent = `${sick_leave} days`; // mapping sick_leave as Hospital Leave
                } catch (err) {
                  console.error("❌ Failed to load leave balances:", err);
                }
              }
              // Call on page load
              loadLeaveBalancesForCurrentUser();
              </script>



</div>
              <div class="form-group"> 
                <label>Leave Type</label>   
                <select name="leave_type" required> 
                  <option value="">Select a leave type</option> 
                  <option value="Casual Leave">Casual Leave</option> 
                  <option value="Earned Leave">Earned Leave</option> 
                  <option value="Sick Leave">Sick Leave</option> 
                </select> </div> </div> <div class="form-row"> 
                  <div class="form-group"> <label>Start Date</label> 
                    <input type="date" id="start_date" name="start_date" required> 
                  </div> <div class="form-group"> 
                    <label>End Date</label> 
                    <input type="date" id="end_date" name="end_date" required> 
                  </div> </div> <div class="form-row"> 
                    <div class="form-group"> 
                      <label>Number of Days</label> 
                      <!-- auto-calculated; user cannot edit directly -->
                      <input type="number" id="no_of_days" name="no_of_days" required readonly>
                    </div> </div> <div class="form-row"> 
                      <div class="form-group"> 
                        <label>Reason for Leave</label> 
                        <textarea name="reason"></textarea> 
                      </div> </div> <div class="checkbox"> 
                        <input type="checkbox" name="away_hq"> During Leave Away from HQ </div> 
                        <div class="status">Status: Pending Approval</div> 
                        <div class="form-buttons"> 
                          <button type="reset" class="btn cancel">Cancel</button> 
                          <button type="submit" class="btn submit">Submit</button> 
                        </div> 
                      <!-- </form>  -->
        <!-- </form> -->
        </div>
      </div>
    </div>
  </div>

  <!-- Leave Applications Section -->
  <section id="leave-applications" class="section">
  <div class="container">
    <div class="text-center mb-4">
      <h2 class="fw-bold text-primary">Leave Applications</h2>
      <p class="text-muted">View and manage your leave applications</p>
    </div>

    <div class="card p-4">
      <div class="d-flex justify-content-between mb-3">
        <a href="leave.html" class="btn btn-primary">
          + Apply Leave
        </a>
        <input type="text" class="form-control w-25" placeholder="Search by Leave Type, Reason" id="leavesearchInput">
      </div>

      <table id="leaveTable" class="styled-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>EmployeeID</th>
            <th>Leave type</th>
            <th>From date</th>
            <th>To Date</th>
            <th>Reason</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <!-- Pagination controls -->
      <div id="leavePagination" class="pagination" style="margin-top:12px; display:flex; gap:8px; align-items:center;"></div>
    </div>
  </div>
</section>
    <style>
    /* Pagination styling (match manager.html) */
    .pagination { font-family: inherit; }
    .pagination button {
      background: #fff;
      border: 1px solid #ddd;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    .pagination button:hover { background: #f4f6fb; }
    .pagination button[disabled] { opacity: 0.5; cursor: default; }
    .pagination .page-number.active {
      background: #3a86ff; color: #fff; border-color: #2a6cd4;
    }
    .pagination .page-info { color: #555; margin-left: 8px; }
    </style>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>

    // auto-calculate number of days between start and end (inclusive)
    (function () {
      function calculateNoOfDays() {
        const startEl = document.getElementById('start_date');
        const endEl = document.getElementById('end_date');
        const outEl = document.getElementById('no_of_days');

        if (!startEl || !endEl || !outEl) return;

        const start = startEl.value;
        const end = endEl.value;

        if (!start || !end) {
          outEl.value = '';
          return;
        }

        const s = new Date(start);
        const e = new Date(end);
        // normalize to UTC midnight to avoid timezone/DST issues
        const utc1 = Date.UTC(s.getFullYear(), s.getMonth(), s.getDate());
        const utc2 = Date.UTC(e.getFullYear(), e.getMonth(), e.getDate());
        let diffDays = Math.floor((utc2 - utc1) / (1000 * 60 * 60 * 24));

        // treat as inclusive days (same start & end => 1)
        if (diffDays >= 0) diffDays = diffDays + 1;

        outEl.value = diffDays >= 0 ? diffDays : '';
      }

      // attach listeners
      document.addEventListener('DOMContentLoaded', function () {
        const s = document.getElementById('start_date');
        const e = document.getElementById('end_date');
        if (s) s.addEventListener('change', calculateNoOfDays);
        if (e) e.addEventListener('change', calculateNoOfDays);
        // calculate if values already present
        calculateNoOfDays();
      });

      //load to db
      document.getElementById('leaveForm').addEventListener('submit', function(e){
        e.preventDefault();

        // basic validation: end must not be before start
        const startVal = this.start_date.value;
        const endVal = this.end_date.value;
        if (startVal && endVal) {
          const sDate = new Date(startVal);
          const eDate = new Date(endVal);
          if (eDate < sDate) {
            alert('End date cannot be before start date.');
            return;
          }
        }

        const payload = {
          leave_type: this.leave_type.value,
          start_date: this.start_date.value,
          end_date: this.end_date.value,
          reason: this.reason.value,
          no_of_days: this.no_of_days.value, // ✅ use .value
          userid: this.userid.value,         // include user ID
          status: 'Pending',
          away_hq: this.away_hq && this.away_hq.checked ? 'yes' : 'no' // send 'yes' if checked, else 'no'
        };

    fetch('https://containers.back4app.com/apps/b20ef7f7-2d91-4c3e-982c-cc65688966c5/api/leave', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    })
    .then(res => res.json().catch(() => null))
    .then(data => {
      if (data && (data.success === true || data.success === 'true')) {
        alert(data.message || 'Leave application submitted');
        this.reset();
        // reset calculated field too
        const out = document.getElementById('no_of_days'); if (out) out.value = '';
        const modalEl = document.getElementById('leaveModal');
        try { if (modalEl && bootstrap && bootstrap.Modal) bootstrap.Modal.getInstance(modalEl).hide(); } catch(e){}
      } else {
        alert((data && data.message) || 'Failed to submit leave');
      }
    })
    .catch(err => { console.error(err); alert('An error occurred while submitting leave'); });
      });
    })();

//fetch from db
// Pagination for leave applications (10 per page)
const LEAVES_PER_PAGE = 10;
let leavesDataAll = [];
let leavesFiltered = [];
let currentLeavePage = 1;

async function loadLeaves() {
  try {
    const res = await fetch('/api/leaves');
    const data = await res.json();

    leavesDataAll = Array.isArray(data) ? data : [];
    leavesFiltered = leavesDataAll.slice();
    currentLeavePage = 1;
    renderLeavesPage(currentLeavePage);
  } catch (err) {
    console.error('Error loading leaves:', err);
  }
}

function renderLeavesPage(page = 1) {
  const tbody = document.querySelector('#leaveTable tbody');
  tbody.innerHTML = '';

  const total = leavesFiltered.length;
  const totalPages = Math.max(1, Math.ceil(total / LEAVES_PER_PAGE));
  if (page < 1) page = 1;
  if (page > totalPages) page = totalPages;
  currentLeavePage = page;

  const start = (page - 1) * LEAVES_PER_PAGE;
  const pageItems = leavesFiltered.slice(start, start + LEAVES_PER_PAGE);

  if (pageItems.length === 0) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="7" style="text-align:center;color:#666;padding:18px;">No records found.</td>`;
    tbody.appendChild(tr);
  } else {
    pageItems.forEach(leave => {
      const row = `
        <tr>
          <td>${leave.id}</td>
          <td>${leave.employeeID}</td>
          <td>${leave.leave_type}</td>
          <td>${new Date(leave.start_date).toLocaleDateString()}</td>
          <td>${new Date(leave.end_date).toLocaleDateString()}</td>
          <td>${leave.reason}</td>
          <td>${leave.status}</td>
        </tr>`;
      tbody.insertAdjacentHTML('beforeend', row);
    });
  }

  renderLeavePaginationControls(totalPages);
}

function renderLeavePaginationControls(totalPages) {
  const container = document.getElementById('leavePagination');
  if (!container) return;
  container.innerHTML = '';
  const total = leavesFiltered.length;
  if (total === 0) return;

  const prev = document.createElement('button');
  prev.textContent = 'Prev';
  prev.disabled = currentLeavePage === 1;
  prev.onclick = () => renderLeavesPage(currentLeavePage - 1);
  container.appendChild(prev);


  const maxButtons = 7;
  let startPage = 1;
  let endPage = totalPages;
  if (totalPages > maxButtons) {
    const half = Math.floor(maxButtons / 2);
    startPage = Math.max(1, currentLeavePage - half);
    endPage = startPage + maxButtons - 1;
    if (endPage > totalPages) {
      endPage = totalPages;
      startPage = endPage - maxButtons + 1;
    }
  }

  if (startPage > 1) {
    const btn = document.createElement('button');
    btn.textContent = '1';
    btn.className = 'page-number';
    btn.onclick = () => renderLeavesPage(1);
    container.appendChild(btn);
    if (startPage > 2) {
      const dots = document.createElement('span');
      dots.textContent = '...';
      dots.style.margin = '0 6px';
      container.appendChild(dots);
    }
  }

  for (let i = startPage; i <= endPage; i++) {
    const btn = document.createElement('button');
    btn.textContent = String(i);
    btn.className = 'page-number' + (i === currentLeavePage ? ' active' : '');
    btn.onclick = () => renderLeavesPage(i);
    container.appendChild(btn);
  }

  if (endPage < totalPages) {
    if (endPage < totalPages - 1) {
      const dots = document.createElement('span');
      dots.textContent = '...';
      dots.style.margin = '0 6px';
      container.appendChild(dots);
    }
    const btn = document.createElement('button');
    btn.textContent = String(totalPages);
    btn.className = 'page-number';
    btn.onclick = () => renderLeavesPage(totalPages);
    container.appendChild(btn);
  }

  const next = document.createElement('button');
  next.textContent = 'Next';
  next.disabled = currentLeavePage === totalPages || totalPages === 0;
  next.onclick = () => renderLeavesPage(currentLeavePage + 1);
  container.appendChild(next);

  const info = document.createElement('span');
  info.className = 'page-info';
  const from = total === 0 ? 0 : (start + 1);
  const to = Math.min(start + LEAVES_PER_PAGE, total);
  info.textContent = `Showing ${from}-${to} of ${total}`;
  container.appendChild(info);
}

// initial load
loadLeaves();
setInterval(loadLeaves, 5000);
document.getElementById('leavesearchInput').addEventListener('keyup', function () {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('#leaveTable tbody tr');

    rows.forEach(row => {
        const rowText = row.textContent.toLowerCase();
        row.style.display = rowText.includes(searchTerm) ? '' : 'none';
    });
});

// auto refresh every 5 seconds
setInterval(loadLeaves, 5000);
  </script>
  
<!--holiday-->
<section id="company-holiday-view-section" class="company-holiday-section section">
  <div class="company-holiday-header" style="display:flex;justify-content:space-between;align-items:center;">
    <h1>Company Holidays</h1>
  </div>
  <div class="company-holiday-table-container">
    <table class="company-holiday-table styled-table" id="company-holiday-view-table">
      <thead>
        <tr>
          <th>YEAR</th>
          <th>DATE</th>
          <th>NAME OF THE HOLIDAY</th>
        </tr>
      </thead>
      <tbody id="company-holiday-view-table-body">
        <tr><td colspan="3" style="text-align:center;color:#888;">Loading...</td></tr>
      </tbody>
    </table>
  </div>
</section>

<style>
.company-holiday-section .company-holiday-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.company-holiday-table {
  width: 100%;
  margin-top: 20px;
}
</style>

<script>
function formatDateDMY(dateStr) {
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr;
  const day = String(d.getDate()).padStart(2, '0');
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const year = d.getFullYear();
  return `${day}-${month}-${year}`;
}

async function loadCompanyHolidaysView() {
  const tbody = document.getElementById('company-holiday-view-table-body');
  tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#888;">Loading...</td></tr>';
  try {
    const res = await fetch('/holidays');
    let data = await res.json();
    // Sort by date descending (latest first)
    data.sort((a, b) => new Date(b.date) - new Date(a.date));
    tbody.innerHTML = '';
    if (!Array.isArray(data) || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#888;">No holidays added.</td></tr>';
      return;
    }
    data.forEach(holiday => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${holiday.year}</td>
        <td>${formatDateDMY(holiday.date)}</td>
        <td>${holiday.name}</td>
      `;
      tbody.appendChild(tr);
    });
  } catch (err) {
    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#c00;">Error loading holidays</td></tr>';
  }
}

document.addEventListener('DOMContentLoaded', loadCompanyHolidaysView);
</script>

<!-- REPORT SECTION -->
 
    <style>
.report-form {
  background: #fff;
  padding: 100px;
  border: 1px solid #e0e0e0;
  border-radius: 12px;
  max-width: 10000px;
  margin: 20px auto;
  font-family: "Segoe UI", Arial, sans-serif;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.section-header h1 {
  margin-bottom: 5px;
  font-size: 24px;
  font-weight: 600;
  color: #333;
}

.section-header p {
  margin-bottom: 20px;
  color: #777;
}

h3 {
  margin-top: 25px;
  margin-bottom: 8px;
  font-size: 18px;
  font-weight: 600;
  color: #444;
}

p {
  margin: 0 0 15px 0;
  color: #666;
  font-size: 14px;
}

.report-type-row {
  display: flex;
  gap: 20px;
  margin-bottom: 25px;
}
.report-option {
  flex: 1;
  border: 2px solid #ddd;
  border-radius: 10px;
  padding: 16px 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  transition: 0.2s ease;
  background: #fafafa;
  white-space: nowrap; /*  prevents text from wrapping */
}

.report-option span {
  font-size: 15px;
  font-weight: 500;
  color: #333;
}

.report-option:hover {
  border-color: #007bff;
  background: #f0f8ff;
}

.report-option input {
  accent-color: #007bff;
  transform: scale(1.2);
}

.parameters-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px 40px;
  margin-bottom: 25px;
}

.parameters-grid label {
  display: block;
  font-weight: 600;
  margin-bottom: 6px;
  font-size: 14px;
  color: #333;
}

.parameters-grid input,
.parameters-grid select {
  width: 100%;
  padding: 10px;
  font-size: 14px;
  border: 1px solid #ccc;
  border-radius: 6px;
  transition: border-color 0.2s ease;
}

.parameters-grid input:focus,
.parameters-grid select:focus {
  border-color: #007bff;
  outline: none;
}

.form-footer {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 20px;
  margin-top: 20px;
}

.form-footer span {
  color: #555;
  font-weight: 600;
}

.btn-generate {
  background: #007bff;
  border: none;
  padding: 10px 20px;
  cursor: pointer;
  border-radius: 6px;
  color: #fff;
  font-size: 15px;
  font-weight: 500;
  transition: background 0.2s ease;
}

.btn-generate:hover {
  background: #0056b3;
}
</style>





    <script src="script.js"></script>
</body>
</html>